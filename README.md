# Secure Cloud Environment on Azure with Terraform

> **Goal:** Design & deploy a minimal yet security‑focused Azure environment using Terraform.

## 1. Architecture Overview

```
Internet (your /32)
   │  SSH (22) allowed only from your IP
   ▼
[Bastion VM]  (public subnet 10.0.1.0/24, public IP)
   │  SSH ProxyJump only
   ▼
[Private VM] (private subnet 10.0.2.0/24, no public IP)
   │  Managed Identity + VNet service endpoint (KeyVault)
   ▼
[Azure Key Vault] (RBAC enabled, network ACL: only private subnet)
```

**Key controls**

* NSG Public: Allow TCP/22 from `my_ip_cidr` only; deny rest.
* NSG Private: Allow TCP/22 from public subnet `10.0.1.0/24`; deny rest.
* Key Vault: `enable_rbac_authorization=true`, soft delete + purge protection, network ACL restricted to private subnet (optionally temp allow your /32 to create secrets).
* Private VM: system-assigned Managed Identity with roles `Reader` + `Key Vault Secrets User` on the KV.

## 2. Repo Layout

```
root/
  main.tf
  outputs.tf
  provider.tf
  terraform.tfvars (contains my_ip_cidr = "x.x.x.x/32")
  modules/
    network/
    compute/
    compute_private/
    keyvault/
```

## 3. Prerequisites

* Azure subscription + `az login`
* Terraform ≥ 1.6
* Sufficient permissions to create RG, VNet, NIC, VM, Key Vault, role assignments.
* Your **public** IP (to set `my_ip_cidr = "<YOUR.IP>/32"`).

## 4. Variables (root)

Set in `terraform.tfvars`:

```hcl
my_ip_cidr = "<YOUR.IP>/32"
```

## 5. Deploy

```bash
terraform init -upgrade
terraform fmt -recursive
terraform apply -auto-approve
```

Expected outputs:

```bash
bastion_public_ip           = "x.x.x.x"
private_vm_ip               = "10.0.2.x"
keyvault_name               = "kv-secureenv-<suffix>"
keyvault_uri                = "https://kv-secureenv-<suffix>.vault.azure.net/"
```

## 6. Post-deploy: Create/Verify Secrets

> If TF didn’t create secrets earlier due to KV firewall, temporarily allow your IP in module `keyvault` (`admin_ip_cidr`).

Create via Terraform (preferred):

```bash
terraform plan -target=module.keyvault.azurerm_key_vault_secret.db_password -out tfp1
terraform apply tfp1
```

Or via Azure CLI (quick):

```bash
KV=$(terraform output -raw keyvault_name)
az keyvault secret set --vault-name "$KV" --name db-password --value "$(openssl rand -base64 24)"
```

Verify:

```bash
az keyvault secret list --vault-name "$KV" -o table
```

## 7. Access Tests (Validation)

### 7.1 Bastion reachable only from your IP

```bash
nc -vz $(terraform output -raw bastion_public_ip) 22
ssh -i .ssh/bastion_id_rsa azureuser@$(terraform output -raw bastion_public_ip)
```

### 7.2 SSH jump to Private VM

One‑liner (two keys):

```bash
ssh -o "ProxyCommand=ssh -i $(terraform output -raw bastion_private_key_path) -W %h:%p $(terraform output -raw bastion_admin_username)@$(terraform output -raw bastion_public_ip)" \
    -i $(terraform output -raw private_vm_key_path) \
    $(terraform output -raw private_vm_admin_username)@$(terraform output -raw private_vm_ip) "hostname && ip -br a"
```

Optional `~/.ssh/config` for convenience:

```sshconfig
Host bastion-secureenv
  HostName <bastion_public_ip>
  User azureuser
  IdentityFile ~/.ssh/bastion_id_rsa
  IdentitiesOnly yes

Host private-secureenv
  HostName <private_vm_ip>
  User azureuser
  IdentityFile ~/.ssh/private_vm_id_rsa
  IdentitiesOnly yes
  ProxyJump bastion-secureenv
```

### 7.3 Key Vault access from Private VM via MI

On the **Private VM**:

```bash
curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash   # install az if needed
az login --identity
az keyvault secret show --vault-name $(terraform output -raw keyvault_name) \
  --name db-password --query value -o tsv
```

Expected: a random password value.

## 8. Security Measures Explained

* **Network segmentation**: public vs private subnet; no public IP on workloads.
* **NSGs as default‑deny**: only explicit allowed flows (SSH from your /32; from bastion to private).
* **Just‑enough access**: Managed Identity on Private VM; `Reader` + `Key Vault Secrets User` only.
* **Secret management**: Key Vault RBAC; soft delete + purge protection; KV network restricted to private subnet.
* **Ephemeral admin access**: your /32 allowed; rotate if your IP changes.
* **No secrets in repo**: keys generated by `tls_private_key`; private keys not committed.

## 9. Operations

### Update your public IP

```bash
# edit terraform.tfvars
my_ip_cidr = "<NEW.IP>/32"
terraform apply -auto-approve
```

### Lock down Key Vault after bootstrap

Set in `modules/keyvault/main.tf`:

```hcl
network_acls { ip_rules = [] }  # remove your /32
```

Then:

```bash
terraform apply -auto-approve
```

### Cost control

* Use `Standard_B1s` VMs; stop/destroy when done:

```bash
terraform destroy -auto-approve
```

## 10. Troubleshooting

**SSH to bastion times out**

* IP changed? Update `my_ip_cidr` and `terraform apply`.
* Check NSG rules and association to public subnet.

**Jump SSH fails with permission denied**

* Use distinct keys for bastion and private VM (see one‑liner above).

**`az login --identity` fails on your laptop**

* Must be executed **on an Azure VM** with Managed Identity.

**Key Vault 403 during `terraform apply`**

* Ensure `enable_rbac_authorization = true` and role assignment for your principal: `Key Vault Secrets Officer`.
* Temporarily allow your /32 via `admin_ip_cidr` in KV `network_acls`.

**`SecretNotFound` on Private VM**

* Create the secret via Terraform or `az keyvault secret set` from your machine, then retry on the VM.

## 11. Deliverable Checklist

* [ok ] Code modular (network/compute/compute\_private/keyvault)
* [ok ] README present (this file)
* [ok ] Security measures explained (section 8)
* [ok ] Screenshots: Azure RG, NSGs, VMs, KV Networking, SSH jump session, `az login --identity` + secret read
* [ok ] Cleanup / cost control plan

---

### Appendix: Example Outputs

```bash
bastion_admin_username = "azureuser"
bastion_private_key_path = "./.ssh/bastion_id_rsa"
bastion_public_ip = "4.180.237.185"
private_vm_admin_username = "azureuser"
private_vm_ip = "10.0.2.4"
private_vm_key_path = "./.ssh/private_vm_id_rsa"
keyvault_name = "kv-secureenv-zufui8"
keyvault_uri = "https://kv-secureenv-zufui8.vault.azure.net/"
```
